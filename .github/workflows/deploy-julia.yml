name: Fix Version and Deploy Julia Package

on:
    release:
        types: [created]

permissions:
    contents: write
    issues: write
    pull-requests: write

jobs:             
    update-version-for-julia:
        runs-on: ubuntu-latest
        env:
            GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Install Git
              run: sudo apt-get install git

            - name: Determine Version
              id: versioning
              run: |
                  if [[ $GITHUB_REF =~ refs/tags/v* ]]; then
                    # If build is triggered by a tag
                    VERSION=${GITHUB_REF#refs/tags/v}
                  else
                    # If build is triggered by a branch push without a tag, use the latest tag from main
                    VERSION=$(git describe --tags $(git rev-list --tags --max-count=1))
                    VERSION=${VERSION#v}  # Strip 'v' prefix if present in tags
                  fi
                  echo "VERSION=${VERSION}" >> $GITHUB_ENV
                  echo "Version determined: ${VERSION}"

            - name: Update Project.toml File
              run: |
                  sed -i "s/^version = .*/version = \"${{ env.VERSION }}\"/" Project.toml

            - name: Install GitHub CLI
              run: sudo apt-get install gh jq -y

            - name: Commit and push changes
              run: |
                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action"
                  git fetch origin main
                  original_main_sha=$(git rev-parse origin/main)
                  # Check for changes in the Project.toml file
                  git add Project.toml
                  if git diff --staged --quiet; then
                    echo "No changes detected. Skipping branch creation and pull request."
                    exit 0
                  fi
                  # Create a new branch FROM origin/main
                  git checkout -b update-julia-version-${GITHUB_RUN_ID} origin/main
                  git commit -m "Update Julia package version to ${{ env.VERSION }}"
                  git push -u origin update-julia-version-${GITHUB_RUN_ID}

                  # Create Pull Request and capture PR number
                  pr_url=$(gh pr create --title "Update Julia Package Version" --body "Auto-update version to ${{ env.VERSION }} by CI/CD." --base main --head update-julia-version-${GITHUB_RUN_ID})

                  # Wait briefly to avoid race conditions
                  sleep 5

                  # Get the PR node ID (required for GraphQL)
                  pr_node_id=$(gh pr view "$pr_url" --json id -q .id)

                  # Enable auto-merge via GitHub GraphQL API
                  curl -X POST -H "Authorization: bearer ${{ secrets.GITHUB_TOKEN }}" \
                        -H "Content-Type: application/json" \
                        -d '{"query":"mutation { enablePullRequestAutoMerge(input: { pullRequestId: \"'"$pr_node_id"'\" mergeMethod: SQUASH }) { pullRequest { number autoMergeRequest { enabledAt } } } }"}' \
                        https://api.github.com/graphql

                  # Automatically merge the PR
                  gh pr merge --auto --squash --delete-branch

    register-julia-package:
        runs-on: ubuntu-latest
        needs: [update-version-for-julia]

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v3

            - name: Install GitHub CLI
              run: sudo apt-get install gh

            # Post Registrator Comment on Issue #1
            - name: Trigger Registrator
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  gh issue comment --repo equicirco/DualSignals.jl \
                    --body $'@JuliaRegistrator register \n \n Release notes: \n \n There are no breaking changes. See the changelog.' \
                    1
